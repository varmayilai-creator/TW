
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onam 2024 - TrailWalkers</title>
    <style>
        :root {
            --primary-color: #0B3D91; /* A deep, festive blue */
            --secondary-color: #FFD700; /* A vibrant gold/yellow */
            --accent-color: #2E8B57; /* A rich green */
            --background-color: #FDFDFD;
            --text-color: #333333;
            --header-bg: #FFFFFF;
            --footer-bg: #333333;
            --footer-text: #FFFFFF;
            --tab-highlight: #FFD700;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background: var(--header-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 20px;
        }

        .logo {
            font-weight: bold;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }

        nav ul li {
            margin-left: 25px;
        }

        nav a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            padding-bottom: 5px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        nav a.active, nav a:hover {
            color: var(--primary-color);
            border-bottom-color: var(--tab-highlight);
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(rgba(11, 61, 145, 0.8), rgba(11, 61, 145, 0.8)), url('https://www.keralatourism.org/images/festivals/onam/onam_sadya.jpg') no-repeat center center/cover;
            color: white;
            padding: 6rem 1rem;
            text-align: center;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .hero p {
            font-size: 1.25rem;
            margin-bottom: 0;
        }
        
        .hero .subtitle {
            font-size: 1.5rem;
            color: var(--secondary-color);
            font-weight: 600;
            margin-top: 10px;
        }

        /* Main Content */
        main {
            padding: 2rem 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Section Styles */
        .section {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .section h2 {
            font-size: 2rem;
            color: var(--primary-color);
            margin-top: 0;
            border-bottom: 3px solid var(--secondary-color);
            display: inline-block;
            padding-bottom: 10px;
            margin-bottom: 1.5rem;
        }

        /* Table Styles for Sadya Tab */
        .sadya-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        .sadya-table th, .sadya-table td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .sadya-table th {
            background-color: var(--secondary-color);
            color: #333;
            font-weight: 600;
        }

        .sadya-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .sadya-table tr:hover {
            background-color: #f1f1f1;
        }
        
        .sadya-table select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background-color: #fff;
            cursor: pointer;
        }
        
        .sadya-table select:disabled {
            cursor: not-allowed;
            background-color: #eee;
        }
        
        /* Sadya Dashboard */
        #sadya-dashboard {
            background-color: #f1f1f1;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        #sadya-dashboard p { margin: 0; }
        #unassigned-items-list {
            margin-top: 10px;
            font-weight: 500;
            color: var(--primary-color);
        }

        /* Loader */
        .loader {
            text-align: center;
            padding: 2rem;
        }
        .loader .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer */
        footer {
            background: var(--footer-bg);
            color: var(--footer-text);
            text-align: center;
            padding: 1.5rem 1rem;
            margin-top: 2rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 { font-size: 2.5rem; }
            header .container { flex-direction: column; }
            nav ul { margin-top: 1rem; }
        }

    </style>
</head>
<body>

    <header>
        <div class="container">
            <div class="logo">TrailWalkers</div>
            <nav>
                <ul>
                    <li><a href="#venue" class="nav-link active">Date and Venue</a></li>
                    <li><a href="#programs" class="nav-link">Programs</a></li>
                    <li><a href="#sadya" class="nav-link">Sadya Items</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="hero">
            <h1>Onam 2024</h1>
            <p>Join us for a day of celebration, feast, and festivities!</p>
            <p class="subtitle">Organised by the TrailWalkers</p>
        </div>

        <div class="container">
            <div id="venue" class="tab-content active">
                <section class="section">
                    <h2>Date and Venue</h2>
                    <p><strong>Date:</strong> Saturday, 21st September 2024</p>
                    <p><strong>Time:</strong> 10:00 AM - 4:00 PM</p>
                    <p><strong>Location:</strong> Community Hall, XYZ Place, Melbourne</p>
                </section>
            </div>

            <div id="programs" class="tab-content">
                <section class="section">
                    <h2>Programs & Activities</h2>
                    <ul>
                        <li>Pookalam (Floral Carpet) Competition</li>
                        <li>Onam Sadya (The Grand Feast)</li>
                        <li>Thiruvathira Kali (Traditional Dance)</li>
                        <li>Fun games for all ages</li>
                        <li>And much more...</li>
                    </ul>
                </section>
            </div>

            <div id="sadya" class="tab-content">
                <section class="section">
                    <h2>Sadya Contributions Dashboard</h2>
                    <p>This is a live dashboard. Select your name from a dropdown to claim a dish. The list updates automatically for everyone.</p>
                    
                    <div id="sadya-dashboard">
                         <p>Loading summary...</p>
                    </div>

                    <div id="sadya-table-container">
                        <div class="loader">
                            <div class="spinner"></div>
                            <p>Loading Sadya items from our list...</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 TrailWalkers Community. Let's make this Onam memorable!</p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const navLinks = document.querySelectorAll('.nav-link');
        const tabContents = document.querySelectorAll('.tab-content');

        function activateTab(tabId) {
            navLinks.forEach(link => {
                link.classList.toggle('active', link.hash === tabId);
            });
            tabContents.forEach(content => {
                content.classList.toggle('active', '#' + content.id === tabId);
            });
        }

        // Handle initial tab from URL hash
        const initialTab = window.location.hash || '#venue';
        activateTab(initialTab);
        if (initialTab === '#sadya') {
            fetchSadyaData();
        }

        // Handle tab clicks
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabId = link.hash;
                window.location.hash = tabId;
                activateTab(tabId);
                if (tabId === '#sadya') {
                    fetchSadyaData();
                }
            });
        });
        
        // Handle back/forward navigation
        window.addEventListener('hashchange', () => {
             const tabId = window.location.hash || '#venue';
             activateTab(tabId);
             if (tabId === '#sadya') {
                fetchSadyaData();
            }
        });

    });

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxdw1O5_9cVdyIADuqv3N6Q5bGz8TOlMNT0qeeI8O2DDQ7QsjEgQj1jBEZNeWoFykmh/exec";
    const sadyaContainer = document.getElementById('sadya-table-container');
    const sadyaDashboard = document.getElementById('sadya-dashboard');
    let sadyaDataCache = [];
    
    const contributors = [
        "Anitha", "Anna", "Anu", "Deepthi", "Diana", "Dinu", 
        "Josna", "Liji", "Manju", "Parvathy", "Priya", "Sowmya", "Susan"
    ];

    async function fetchSadyaData() {
        // Show loader only if data isn't cached
        if (sadyaDataCache.length === 0) {
            sadyaContainer.innerHTML = `<div class="loader"><div class="spinner"></div><p>Loading Sadya items...</p></div>`;
        }

        try {
            const response = await fetch(`${SCRIPT_URL}?action=read`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();

            if (result.status === 'success') {
                sadyaDataCache = result.data;
                renderSadyaTable(sadyaDataCache);
                updateDashboard(sadyaDataCache);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error fetching Sadya data:', error);
            sadyaContainer.innerHTML = `<p style="color: red; font-weight: bold;">Error loading data: ${error.message}. Please check the browser console and Google Sheet setup.</p>`;
        }
    }

    function renderSadyaTable(data) {
        const tableHTML = `
            <table class="sadya-table">
                <thead>
                    <tr>
                        <th>Dish Name</th>
                        <th>Description</th>
                        <th>Owner / Contributor</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(item => `
                        <tr>
                            <td>${item.dishName}</td>
                            <td>${item.description}</td>
                            <td>
                                <select data-dish="${item.dishName}" onchange="handleOwnerChange(this)" ${item.owner ? 'disabled' : ''}>
                                    <option value="">-- Select --</option>
                                    ${contributors.map(c => `
                                        <option value="${c}" ${item.owner === c ? 'selected' : ''}>${c}</option>
                                    `).join('')}
                                     ${item.owner ? `<option value="" style="font-weight:bold; color:red;">Clear Assignment</option>` : ''}
                                </select>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        sadyaContainer.innerHTML = tableHTML;
    }
    
    function updateDashboard(data) {
        const assignedItems = data.filter(item => item.owner);
        const unassignedItems = data.filter(item => !item.owner);
        const contributions = assignedItems.reduce((acc, item) => {
            acc[item.owner] = (acc[item.owner] || 0) + 1;
            return acc;
        }, {});

        let summaryHTML = `<p><strong>${assignedItems.length} of ${data.length}</strong> items have been claimed.</p>`;
        
        if (Object.keys(contributions).length > 0) {
             summaryHTML += `<p><strong>Contributions:</strong> ${Object.entries(contributions).map(([name, count]) => `${name} (${count})`).join(', ')}</p>`;
        }

        if (unassignedItems.length > 0) {
            summaryHTML += `<div id="unassigned-items-list"><strong>Still Needed:</strong> ${unassignedItems.map(i => i.dishName).join(', ')}</div>`;
        } else {
            summaryHTML += `<div id="unassigned-items-list" style="color: var(--accent-color);"><strong>All items have been claimed! Great job everyone!</strong></div>`;
        }

        sadyaDashboard.innerHTML = summaryHTML;
    }

    async function handleOwnerChange(selectElement) {
        const dishName = selectElement.dataset.dish;
        const newOwner = selectElement.value;
        
        // Show a simple spinner in the dropdown
        const originalText = selectElement.options[selectElement.selectedIndex].text;
        selectElement.options[selectElement.selectedIndex].text = 'Saving...';
        selectElement.disabled = true;

        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain', // Use text/plain for Apps Script POST
                },
                body: JSON.stringify({
                    action: 'update',
                    dishName: dishName,
                    owner: newOwner
                })
            });

            if (!response.ok) throw new Error(`Network response was not ok. Status: ${response.status}`);
            const result = await response.json();

            if (result.status === 'success') {
                // Update local cache and re-render
                const itemIndex = sadyaDataCache.findIndex(item => item.dishName === dishName);
                if (itemIndex !== -1) {
                    sadyaDataCache[itemIndex].owner = newOwner;
                }
                renderSadyaTable(sadyaDataCache); // Re-render to update disabled states
                updateDashboard(sadyaDataCache);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error updating owner:', error);
            alert(`Failed to save change: ${error.message}. The page will now reload to get the latest data.`);
            window.location.reload();
        } finally {
            // The table is re-rendered, so no need to reset the specific select element
        }
    }
</script>


</body>
</html>
